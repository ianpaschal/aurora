<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>core/Engine.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Component.html">Component</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Component.html#apply">apply</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Component.html#clone">clone</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Component.html#copy">copy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Component.html#getData">getData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Component.html#getType">getType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Component.html#getUUID">getUUID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Component.html#setData">setData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Component.html#setType">setType</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Engine.html">Engine</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#_update">_update</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#getAssembly">getAssembly</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#getComponent">getComponent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#getEntity">getEntity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#getGeometry">getGeometry</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#getPlayer">getPlayer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#getScene">getScene</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#registerAssembly">registerAssembly</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#registerComponent">registerComponent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#registerEntity">registerEntity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#registerPlayer">registerPlayer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#registerPluginLocation">registerPluginLocation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#registerSystem">registerSystem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#start">start</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Engine.html#stop">stop</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Entity.html">Entity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#_addComponent">_addComponent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#_removeComponent">_removeComponent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#advanceTasks">advanceTasks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#appendTasks">appendTasks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#clone">clone</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#copy">copy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#getComponent">getComponent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#getComponentList">getComponentList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#getComponents">getComponents</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#getData">getData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#getType">getType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#getUUID">getUUID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#hasComponent">hasComponent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#insertTasks">insertTasks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#print">print</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#setComponentData">setComponentData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#setTasks">setTasks</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Player.html">Player</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Player.html#getEntityUUIDs">getEntityUUIDs</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Player.html#own">own</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="System.html">System</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="System.html#_addWatchedComponents">_addWatchedComponents</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="System.html#_removeWatchedComponents">_removeWatchedComponents</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="System.html#_setWatchAll">_setWatchAll</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="System.html#addEntity">addEntity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="System.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="System.html#isWatching">isWatching</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="System.html#update">update</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#optimistic">optimistic</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">core/Engine.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Aurora is distributed under the MIT license.

import FS from "fs";
import Path from "path";
import * as Three from "three";
import Entity from "./Entity";
import Player from "./Player";
import validate from "../utils/validate";
import graphicsSystem from "../plugins/systems/graphics.js";
import terrainSystem from "../plugins/systems/terrain.js";

/** @classdesc Core singleton representing an instance of the Aurora Engine. The
	* engine is responsible for the creation (and registration) of entities, as
	* well as initialization and running of systems containing game logic.
	* @returns - The newly created Engine.
	*/
class Engine {

	/** @description Create an instance of the Aurora Engine. */
	constructor() {
		console.log( "Initializing a new Engine." );

		this._scene = new Three.Scene();
		this._pluginLocations = [];

		// These are the things which are actually saved per game:
		this._entities = [];
		this._world = {
			time: 0,
			name: ""
		};
		this._players = [];

		// Static Resources:
		this._assemblies = [];
		this._components = [];
		/* NOTE: Registering components with the engine doesn't make much sense.
			Virtually all components won't use a default value and the useful part--
			the data--is already included in assemblies. Also, since entities are
			immutable after registration, there's no need to store components which
			can't be added to/removed from them. The array is preserved for now though
			as a reminder, and may be used in the future for validation (such as not)
			allowing a system to try and watch "unapproved" components. */
		this._systems = [];

		// TODO: Make these into arrays. ,map, .filter and .find all give us what we need.
		this._geometries = {}; // Three.Geometry class does not have .getType() method.
		this._materials = {}; // Three.Material class does not have .getType() method.
		this._sounds = {}; // Sound does not have .getType() method.
		this._textures = {}; // Three.Texture class does not have .getType() method.

		// Timing:
		this._running = false;
		this._lastFrameTime = null;

		return this;
	}

	/** @description Get an assembly (Entity instance) by type.
		* @readonly
		* @param {String} type - Type of assembly to fetch.
		* @returns {(Assembly|null)} - Requested assembly, or null if not found.
		*/
	getAssembly( type ) {
		const match = this._assemblies.find( ( assembly ) => {
			return assembly.getType() === type;
		});
		if ( !match ) {
			console.warn( "Assembly " + type + " could not be found!" );
			return null;
		}
		return match;
	}

	/** @description Get a Component instance by type.
		* @readonly
		* @param {String} type - Type of component to fetch.
		* @returns {(Component|null)} - Requested component, or null if not found.
		*/
	getComponent( type ) {
		const match = this._components.find( ( component ) => {
			return component.getType() === type;
		});
		if ( !match ) {
			console.warn( "Component " + type + " could not be found!" );
			return null;
		}
		return match;
	}

	/** @description Get an Entity instance by UUID.
		* @readonly
		* @param {String} uuid - UUID of the entity to fetch.
		* @returns {(Entity|null)} - Requested entity, or null if not found.
		*/
	getEntity( uuid ) {
		const match = this._entities.find( ( entity ) => {
			return entity.getUUID() === uuid;
		});
		if ( !match ) {
			console.warn( "Entity " + uuid + " could not be found!" );
			return null;
		}
		return match;

	}

	/** @description Get a Three.Geometry instance by type.
		* @readonly
		* @param {String} type - Type of geometry to fetch.
		* @returns {(Geometry|null)} - Requested geometry, or null if not found.
		*/
	getGeometry( type ) {
		if ( this._geometries[ type ] ) {
			return this._geometries[ type ];
		}
		else {
			console.error( "Please supply a valid geometry type." );
		}
	}

	/** @description Get a Player instance by index.
		* @readonly
		* @param {Number} index - Index (player number) to fetch.
		* @returns {(Player|null)} - Requested player, or null if not found.
		*/
	getPlayer( index ) {
		if ( validate( "playerIndex", index ) ) {
			return this._players[ index ];
		}
		console.error( "Please supply a valid player index." );
		return null;
	}

	/** @description Get the glogal scene instance.
		* @readonly
		* @returns {Three.Scene}
		*/
	getScene() {
		return this._scene;
	}

	/** @description Add an Entity instance to to the engine as an assembly.
		* @param {Entity} assembly - Entity instance to add.
		* @returns {Array} - Updated array of assemblies.
		*/
	registerAssembly( assembly ) {
		// TODO: Validation.
		this._assemblies.push( assembly );
		return this._assemblies;
	}

	/** @description Add a Component instance to to the engine.
		* @param {Component} component - Component instance to add.
		* @returns {Array} - Updated array of components.
		*/
	registerComponent( component ) {
		// TODO: Validation.
		this._components.push( component );
		return this._components;
	}

	/** @description Add an Entity instance to to the engine.
		* After being registered and initialized, systems are immutable and updated
		* every game loop.
		* @param {Entity} entity - Entity instance to add.
		* @returns {Array} - Updated array of entities.
		*/
	registerEntity( entity ) {
		// Make entity immutable (component data is still mutable though):
		Object.seal( entity );
		this._entities.push( entity );
		// Check all systems to see if they should be watching this entity:
		this._systems.forEach( ( system ) => {
			if ( system.isWatching( entity.getComponentList() ) ) {
				system.addEntity( entity );
			}
		});
		return this._entities;
	}

	/** @description Add a Player instance to to the engine.
		* @param {Player} player - Player instance to add.
		* @returns {(Array|null)} - Updated array of players, or null if invalid.
		*/
	registerPlayer( player ) {
		if ( validate( "isPlayer", player ) ) {
			this._players.push( player );
			return this._players;
		}
		console.error( "Please supply a valid player instance." );
		return null;
	}

	/** @description Add a location to scan for plugins.
		* @param {String} path - Location (file path) to add.
		* @returns {Array} - Updated array of plugin locations.
		*/
	registerPluginLocation( path ) {
		// TODO: Validation.
		this._pluginsDir = path;
		this._pluginLocations.push( path );
		return this._pluginLocations;
	}

	/** @description Add a System instance to the engine.
		* After being registered and initialized, systems are immutable and updated
		* every game loop.
		* @param {System} system - System instance to initialize and add.
		* @returns {(Array|null)} - Updated array of systems, or null if invalid.
		*/
	registerSystem( system ) {
		if ( validate( "isSystem", system ) ) {
			system.init( this );
			this._systems.push( system );
			return this._systems;
		}
		console.error( "Please supply a valid system instance." );
		return null;
	}

	/** @description Start the execution of the update loop. */
	start() {
		/* Always reset. If engine was stopped and restarted, not resetting could
			cause a massive time jump to be added to all systems. */
		this._lastFrameTime = performance.now();
		this._running = true;
		setInterval( this._update.bind( this ), 1000 / 60 );
	}

	/** @description Stop the execution of the update loop. */
	stop() {
		this._running = false;
	}

	/** @description Update all systems.
		* @private
		*/
	_update() {
		if ( this._running ) {
			const now = performance.now();
			const delta = now - this._lastFrameTime;
			this._lastFrameTime = now;
			this._systems.forEach( ( system ) => {
				system.update( delta );
			});
		}
	}

	init( stack, world, onProgress, onFinished ) {
		// Compute total length:
		let length = 0;
		let loaded = 0;
		for ( const section in stack ) {
			length += Object.keys( stack[ section ] ).length;
		}
		if ( world ) {
			length += Object.keys( world.entities ).length;
		}
		function updateProgress( itemName ) {
			loaded++;
			onProgress( ( loaded / length ) * 100, "Loaded " + itemName );
		}

		// Load assets. On finished, start the world loading/generation routine:
		// onProgress is called when an asset is loaded and passed the
		this.loadAssets( stack, updateProgress, () => {

			// Systems must be intialized after loading so they can use assets:
			this.registerSystem( graphicsSystem );
			this.registerSystem( terrainSystem );

			// If no source is provided, generate a new world:
			if ( !world ) {
				console.warn( "World is missing, a new one will be generated!" );
				this.generateWorld( false, updateProgress, onFinished );
			}
			else {
				this.loadWorld( world, updateProgress, onFinished );
			}
		});
	}

	loadAssets( stack, onProgress, onFinished ) {
		const scope = this;
		let loaded = 0;
		let length = 0;
		for ( const section in stack ) {
			length += Object.keys( stack[ section ] ).length;
		}
		const pluginDir = this._pluginsDir;
		const textureLoader = new Three.TextureLoader();
		const JSONLoader = new Three.JSONLoader();

		// Load these backwards (textures, materials, geometries, aseemblies)
		const loaders = {
			loadTextures() {
				for ( const name in stack.texture ) {
					textureLoader.load(
						Path.join( pluginDir, stack.texture[ name ] ),
						( texture ) => {
							scope._textures[ name ] = texture;
							addLoaded( name );
						},
						undefined,
						( err ) => {
							console.error( "Failed to load", stack.textures[ name ], err );
						}
					);
				}
			},
			loadMaterials() {
				for ( const name in stack.material ) {
					addLoaded( name );
				}
			},
			loadGeometries() {
				for ( const type in stack.geometry ) {
					JSONLoader.load(
						Path.join( pluginDir, stack.geometry[ type ] ),
						( geometry ) => {
							scope._geometries[ type ] = geometry;
							addLoaded( type );
						},
						undefined,
						( err ) => {
							console.error( err );
						}
					);
				}
			},
			loadAssemblies() {
				for ( const name in stack.assembly ) {
					const path = Path.join( pluginDir, stack.assembly[ name ] );
					const json = JSON.parse( FS.readFileSync( path, "utf8" ) );
					scope.registerAssembly( new Entity( json ) );
					addLoaded( name );
				}
			},
			loadIcons() {
				for ( const name in stack.icon ) {
					addLoaded( name );
				}
			}
		};
		for ( const loader in loaders ) {
			loaders[ loader ]();
		}
		function addLoaded( name ) {
			loaded++;
			onProgress( name );
			if ( loaded === length ) {
				onFinished();
			}
		}
	}

	generateWorld( config, onProgress, onFinished ) {

		/* Later, config should be loaded from disk, for now it's hard coded. */
		const resources = {
			food: 100,
			wood: 100,
			metal: 100
		};
		config = config || {
			name: "Test World",
			players: [
				{ name: "Gaia", color: 0xA0B35D, start: { x: 0, y: 0, z: 0 } },
				{ name: "Ian", color: 0x0000ff, start: { x: 50, y: 50, z: 0 } },
				{ name: "Thomas", color: 0xff0000, start: { x: 200, y: -100, z: 0 } },
				{ name: "Winston", color: 0x00ff00, start: { x: -100, x: 200, x: 0 } }
			]
		};

		config.players.forEach( ( data ) => {
			const player = new Player( null, {
				color: new Three.Color( data.color ),
				name: data.name,
				start: new Three.Vector3().copy( data.start ),
				resources: resources
			});
			this.registerPlayer( player );

			// Generate test entities:
			for ( let i = 0; i &lt; 4; i++ ) {
				const entity = new Entity();
				player.own( entity );
				entity.copy( this.getAssembly( "nature-rock-granite" ) );
				entity.setComponentData( "player", {
					index: this._players.indexOf( player )
				});
				entity.setComponentData( "position", {
					x: player.start.x + ( Math.random() * 32 - 16 ),
					y: player.start.y + ( Math.random() * 32 - 16 )
				});
				entity.setComponentData( "rotation", {
					z: Math.random() * Math.PI
				});
				this.registerEntity( entity );
			}
		});

		onFinished();
	}
}

export default Engine;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Mar 18 2018 11:54:59 GMT+0100 (CET) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
